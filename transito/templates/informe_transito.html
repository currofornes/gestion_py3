{% extends "base.html" %}
{% load static %}

{% block title %}Análisis del Tránsito{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'plugins/select2/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/select2/select2-bootstrap4.css' %}">
    
    <style>
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.7); z-index: 10;
            display: none; align-items: center; justify-content: center;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <div class="page-title-head d-flex align-items-center mb-3">
        <div class="flex-grow-1">
            <h4 class="fs-sm text-uppercase fw-bold m-0">
                <i class="ti ti-chart-arrows-vertical me-2"></i> Informe de Tránsito por Departamento
            </h4>
        </div>
    </div>

    <form method="post" id="form-informe">
        {% csrf_token %}
        
        <div class="card mb-3">
            <div class="card-header border-light">
                <h4 class="card-title text-primary"><i class="ti ti-filter me-1"></i> Selección de Contexto</h4>
            </div>
            <div class="card-body">
                
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label fw-bold">Campaña de Tránsito</label>
                        <select name="campana" id="id_campana" class="form-control select2-simple" onchange="location = this.value;">
                            <option value="" disabled {% if not campana_seleccionada %}selected{% endif %}>-- Selecciona una campaña --</option>
                            {% for c in campanas %}
                                <option value="?campana_id={{ c.id }}" {% if campana_seleccionada.id == c.id %}selected{% endif %}>
                                    {{ c.descripcion }} ({{ c.curso_academico }})
                                </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Selecciona la campaña para cargar los centros y materias adscritos.</small>
                    </div>
                </div>

                {% if campana_seleccionada %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">{{ form.centro_origen.label }}</label>
                        {{ form.centro_origen }} {% for error in form.centro_origen.errors %}
                             <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">{{ form.materia.label }}</label>
                        {{ form.materia }}
                        {% for error in form.materia.errors %}
                             <span class="text-danger small">{{ error }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        {% if campana_seleccionada %}
        <div class="card relative-container">
            <div class="loading-overlay" id="loading-overlay">
                <div class="spinner-border text-primary" role="status"></div>
            </div>

            <div class="card-header border-light d-flex justify-content-between align-items-center">
                <h4 class="card-title text-secondary">Análisis Cualitativo</h4>
                <span id="badge-estado" class="badge bg-light text-dark border">Nuevo Informe</span>
            </div>

            <div class="card-body">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">{{ form.cuestiones_generales.label }}</label>
                    {{ form.cuestiones_generales }} <small class="form-text text-muted">Visión global del nivel competencial del alumnado procedente de este centro.</small>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-success"><i class="ti ti-thumb-up me-1"></i> {{ form.fortalezas.label }}</label>
                        {{ form.fortalezas }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-danger"><i class="ti ti-thumb-down me-1"></i> {{ form.debilidades.label }}</label>
                        {{ form.debilidades }}
                    </div>
                </div>

            </div>
            
            <div class="card-footer border-0 text-end">
                <button type="submit" class="btn btn-primary btn-lg px-4">
                    <i class="ti ti-device-floppy me-1"></i> Guardar Informe
                </button>
            </div>
        </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <i class="ti ti-info-circle me-2"></i> Por favor, selecciona una campaña activa para comenzar el análisis.
            </div>
        {% endif %}

    </form>
</div>
{% endblock %}

{% block js %}
    <script src="{% static 'plugins/select2/select2.min.js' %}"></script>

    <script>
        $(document).ready(function () {
            
            // 1. Inicialización de componentes visuales
            $(".select2-simple").select2({
                theme: 'bootstrap4',
                width: '100%'
            });

            // Aplicamos Select2 a los campos generados por Django form
            $("#id_centro_origen, #id_materia").select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: "Selecciona una opción...",
                allowClear: true
            });

            // Ajustamos clases de Bootstrap a los textareas si Django no las puso
            $("textarea").addClass("form-control");


            // 2. LÓGICA AJAX: Cargar datos previos
            // Definimos la función que busca si ya existe informe
            function buscarInformePrevio() {
                var campanaId = "{{ campana_seleccionada.id }}";
                var centroId = $("#id_centro_origen").val();
                var materiaId = $("#id_materia").val();

                // Solo buscamos si ambos campos tienen valor
                if (campanaId && centroId && materiaId) {
                    
                    // Mostrar spinner
                    $("#loading-overlay").css("display", "flex");

                    $.ajax({
                        url: "{% url 'transito:api_check_informe' %}", // Esta URL la crearemos en urls.py
                        data: {
                            'campana_id': campanaId,
                            'centro_id': centroId,
                            'materia_id': materiaId
                        },
                        dataType: 'json',
                        success: function (data) {
                            if (data.existe) {
                                // Rellenar campos
                                $("#id_cuestiones_generales").val(data.cuestiones);
                                $("#id_fortalezas").val(data.fortalezas);
                                $("#id_debilidades").val(data.debilidades);
                                
                                // Actualizar UI para indicar edición
                                $("#badge-estado").removeClass("bg-light text-dark").addClass("bg-warning text-dark").text("Editando Informe Existente");
                                
                                // Toast o alerta suave (Opcional, usando SweetAlert si quieres)
                                // Swal.fire('Datos cargados', 'Se ha recuperado un informe previo.', 'info');
                            } else {
                                // Limpiar campos si no existe (por si cambiaron de un centro con datos a uno sin datos)
                                $("#id_cuestiones_generales").val("");
                                $("#id_fortalezas").val("");
                                $("#id_debilidades").val("");
                                
                                // UI reset
                                $("#badge-estado").removeClass("bg-warning text-dark").addClass("bg-light text-dark").text("Nuevo Informe");
                            }
                        },
                        error: function() {
                            console.error("Error al consultar informe previo");
                        },
                        complete: function() {
                            // Ocultar spinner
                            $("#loading-overlay").fadeOut(200);
                        }
                    });
                }
            }

            // 3. Listeners: Ejecutar búsqueda cuando cambien los selectores
            $("#id_centro_origen, #id_materia").on("change", function() {
                buscarInformePrevio();
            });
            
            // Animación suave en submit
            $('#form-informe').on('submit', function () {
                $('button[type="submit"]').prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...');
            });

        });
    </script>
{% endblock %}