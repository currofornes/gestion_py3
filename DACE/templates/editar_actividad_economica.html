{% extends "base.html" %}
{% load static %}

{% block css %}
    <link href="{% static 'css/plugins/datapicker/datepicker3.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/clockpicker/clockpicker.css' %}" rel="stylesheet">
    <link href="{% static 'css/plugins/iCheck/custom.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}Editar Actividad{% endblock %}

{% block content %}
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-lg-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h2>Gestión Económica Actividad DACE</h2>
                    </div>
                    <div class="ibox-content">
                        <form method="post">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-lg-5">
                                    <div class="panel panel-info">
                                        <div class="panel-heading">
                                            <h3>Listado de alumnado participante</h3>
                                        </div>
                                        <div class="panel-body">
                                            <h4 class="text-center" style="margin-bottom: 20px;">Total
                                                alumnos/as: {{ alumnos_total }}</h4>

                                            <div class="panel-group" id="accordion">
                                                {% for unidad, alumnos in alumnos_por_unidad.items %}
                                                    <div class="panel panel-default">
                                                        <div class="panel-heading">
                                                            <h4 class="panel-title">
                                                                <a data-toggle="collapse" data-parent="#accordion"
                                                                   href="#collapse{{ forloop.counter }}">
                                                                    Alumnado de {{ unidad }} ({{ alumnos|length }})
                                                                </a>
                                                            </h4>
                                                        </div>
                                                        <div id="collapse{{ forloop.counter }}"
                                                             class="panel-collapse collapse {% if forloop.first %}in{% endif %}">
                                                            <div class="panel-body">
                                                                <div class="table-responsive">
                                                                    <table class="table table-striped">
                                                                        <thead>
                                                                        <tr>
                                                                            <th>Nombre</th>
                                                                            <th class="text-center">COMPE</th>
                                                                            <th class="text-center">Pagado</th>
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        {% for alumno in alumnos %}
                                                                            <tr>
                                                                                <td>{{ alumno.alumno.Nombre }}</td>
                                                                                <td class="text-center">
                                                                                    <input type="checkbox"
                                                                                           class="i-checks"
                                                                                           name="compe_{{ alumno.id }}"
                                                                                           {% if alumno.compe %}checked{% endif %}>
                                                                                </td>
                                                                                <td class="text-center">
                                                                                    <input type="checkbox"
                                                                                           class="i-checks"
                                                                                           name="pagado_{{ alumno.id }}"
                                                                                           {% if alumno.ha_pagado %}checked{% endif %}>
                                                                                </td>
                                                                            </tr>
                                                                        {% endfor %}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>

                                        </div>
                                    </div>


                                </div>
                                <div class="col-lg-7">
                                    <div class="panel panel-info">
                                        <div class="panel-heading">
                                            <h3>Control de gastos</h3>
                                        </div>
                                        <div class="panel-body">

                                            <div class="form-group row">
                                                <label class="col-lg-4 col-form-label text-right"> {{ form.AportacionCentro.label_tag }} </label>
                                                <div class="col-lg-2">
                                                    {{ form.AportacionCentro }}
                                                    {% for error in form.AportacionCentro.errors %}
                                                        <span class="text-danger">{{ error }}</span>
                                                    {% endfor %}
                                                </div>

                                                <label class="col-lg-4 col-form-label text-right"><strong> {{ form.CosteAlumnado.label_tag }} </strong></label>
                                                <div class="col-lg-2">
                                                    {{ form.CosteAlumnado }}
                                                    {% for error in form.CosteAlumnado.errors %}
                                                        <span class="text-danger">{{ error }}</span>
                                                    {% endfor %}
                                                </div>


                                            </div>


                                            <!-- Tabla para añadir y listar gastos -->
                                            {{ formset.management_form }}
                                            <div class="table-responsive">
                                                <table class="table table-bordered" id="tabla_gastos">
                                                    <thead>
                                                    <tr>
                                                        <th>Concepto</th>
                                                        <th>Importe (€)</th>
                                                        <th>Tipo</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>

                                                    {% for form in formset %}
                                                        <tr>
                                                            {{ form.id }}
                                                            <!-- Campo oculto para la instancia existente -->
                                                            {{ form.DELETE }}
                                                            <!-- Campo oculto para marcar formularios para eliminación -->
                                                            <td>{{ form.concepto }}</td>
                                                            <td>{{ form.importe }}</td>
                                                            <td>{{ form.tipo }}</td>
                                                            <td>
                                                                <button type="button"
                                                                        class="btn btn-danger btn_eliminar_gasto">
                                                                    Eliminar
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                                <button type="button" class="btn btn-success float-right"
                                                        id="btn_agregar_gasto">
                                                    Añadir
                                                    Gasto
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">Guardar</button>
                            <a href="{% url 'actividadesdace' %}" class="btn btn-secondary">Cancelar</a>
                        </form>

                    </div>
                </div>
            </div>
        </div>


    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'js/plugins/datapicker/bootstrap-datepicker.js' %}"></script>
    <script src="{% static 'js/plugins/datapicker/locales/bootstrap-datepicker.es.min.js' %}"></script>
    <script src="{% static 'js/plugins/clockpicker/clockpicker.js' %}"></script>
    <script src="{% static 'js/plugins/iCheck/icheck.min.js' %}"></script>

    <script>
        $(document).ready(function () {

            const numAlumnos = {{ alumnos_total }}; // Número de alumnos participantes


            $('form').on('keypress', 'input, select', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                }
            });

            $('form').on('submit', function () {
                $('button[type="submit"]').prop('disabled', true).text('Procesando...');
            });

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });


            $('.i-checks').each(function () {
                if ($(this).prop('checked')) {
                    $(this).iCheck('check'); // Marca el checkbox en iCheck
                } else {
                    $(this).iCheck('uncheck'); // Desmarca el checkbox en iCheck
                }
            });

            // Añadir fila de gasto
            $('#btn_agregar_gasto').click(function () {
                const formIdx = $("#id_form-TOTAL_FORMS").val();
                const newRow = `
                    <tr>
                        <td><input type="text" name="form-${formIdx}-concepto" class="form-control" /></td>
                        <td><input type="number" name="form-${formIdx}-importe" step="0.01" class="form-control importe" /></td>
                        <td>
                            <select name="form-${formIdx}-tipo" class="form-control tipo">
                                <option value="General">General</option>
                                <option value="Por alumno">Por alumno</option>
                            </select>
                        </td>
                        <td><button type="button" class="btn btn-danger btn_eliminar_gasto">Eliminar</button></td>
                    </tr>`;

                $("#id_form-TOTAL_FORMS").val(parseInt(formIdx) + 1);
                $('#tabla_gastos tbody').append(newRow);

                recalcularCoste(); // Recalcula inmediatamente después de agregar una fila
            });

            // Eliminar fila de gasto
            $(document).on('click', '.btn_eliminar_gasto', function () {
                $(this).closest('tr').remove();
                const formIdx = $("#id_form-TOTAL_FORMS").val();
                $("#id_form-TOTAL_FORMS").val(parseInt(formIdx) - 1);
                recalcularCoste(); // Recalcula después de eliminar una fila
            });

            // Recalcular coste cuando cambian los importes, tipos o la aportación del Centro
            $(document).on('input change', '.importe, .tipo, .aportes_centro', function () {
                recalcularCoste();
            });

            // Función para recalcular el coste por alumno
            function recalcularCoste() {
                let totalGastos = 0;

                // Recorre cada fila de la tabla de gastos
                $('#tabla_gastos tbody tr').each(function () {
                    // Obtiene el importe y el tipo del gasto
                    const importe = parseFloat($(this).find('.importe').val()) || 0;
                    const tipo = $(this).find('.tipo').val();

                    // Calcula según el tipo de gasto
                    if (tipo === "General") {
                        totalGastos += importe;
                    } else if (tipo === "Por alumno") {
                        totalGastos += importe * numAlumnos; // numAlumnos debe estar definido globalmente
                    }
                });

                // Aportación del centro
                const aportesCentro = parseFloat($('.aportes_centro').val()) || 0;

                // Calcula el coste final por alumno
                const costePorAlumno = (totalGastos - aportesCentro) / numAlumnos;

                // Actualiza el campo del formulario
                $('#id_CosteAlumnado').val(Math.max(costePorAlumno, 0).toFixed(2));
            }
            recalcularCoste();

        })


    </script>
{% endblock %}

